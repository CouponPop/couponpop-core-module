name: Publish Core Module SNAPSHOT

on:
  push:
    branches:
      - dev

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'corretto'

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build with Gradle
        run: ./gradlew build

      # build.gradle에 정의된 baseSnapshotVersion을 읽어서 SNAPSHOT 버전 생성
      - name: Determine SNAPSHOT Version
        id: determine_snapshot_version
        run: |
          # build.gradle에서 baseSnapshotVersion 값을 읽어옴
          BASE_SNAPSHOT_VERSION=$(./gradlew -q printBaseSnapshotVersion)
          SNAPSHOT_VERSION="${BASE_SNAPSHOT_VERSION}-SNAPSHOT" 
          echo "SNAPSHOT_VERSION=$SNAPSHOT_VERSION" >> $GITHUB_ENV
        shell: bash

      # GitHub Packages에 SNAPSHOT 배포
      - name: Publish SNAPSHOT to GitHub Packages
        run: ./gradlew publish -Pversion=${{ env.SNAPSHOT_VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Confirm publish success
        run: echo "✅ Successfully published SNAPSHOT version ${{ env.SNAPSHOT_VERSION }}"